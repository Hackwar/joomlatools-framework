
var process = require('process');
var path    = require('path');
var changed = null;

var UglifyJS = require("uglify-js");
var fs = require('fs');

var assetsPath = path.resolve(__dirname, '../code/libraries/joomlatools/library/resources/assets');

function concat(destination, files) {
	var out = files.map(function(path) {
		return fs.readFileSync(path, 'utf-8');
	});

	fs.writeFileSync(destination, out.join('\n'), 'utf-8');
}

var map = {
    'bootstrap.js': [
        assetsPath+'/js/bootstrap.js'
    ],
    'modernizr.js': [
        assetsPath+'/js/build/modernizr.js'
    ],
    'jquery.magnific-popup.js': [
        assetsPath+'/js/kquery.set.js',
        'node_modules/magnific-popup/dist/jquery.magnific-popup.js',
        assetsPath+'/js/kquery.unset.js'
    ],
    'jquery.js': [
        'node_modules/jquery/dist/jquery.js',
        assetsPath+'/js/koowa.noconflict.js'
    ],
    'jquery.validate.js': [
        assetsPath+'/js/kquery.set.js',
        'node_modules/jquery-validation/dist/jquery.validate.js',
        assetsPath+'/js/jquery.validate.patch.js',
        assetsPath+'/js/kquery.unset.js'
    ],
    'admin.js': [
        assetsPath+'/js/kquery.set.js',
        'node_modules/select2/dist/js/select2.full.min.js',
        'node_modules/magnific-popup/dist/jquery.magnific-popup.min.js',
        'node_modules/footable/dist/footable.min.js',
        'node_modules/floatthead/dist/jquery.floatThead.min.js',
        assetsPath+'/scripts/overflowing.js',
        assetsPath+'/scripts/tabbable.js',
        assetsPath+'/scripts/off-canvas-menu.js',
        assetsPath+'/scripts/main.js',
        assetsPath+'/js/kquery.unset.js'
    ],
    'koowa.datepicker.js': [
        assetsPath+'/js/datepicker.js',
        assetsPath+'/js/koowa.datepicker.js'
    ],
    'koowa.tree.js': [
        assetsPath+'/js/kquery.set.js',
        'node_modules/jqtree/tree.jquery.js',
        assetsPath+'/js/koowa.tree.js',
        assetsPath+'/js/kquery.unset.js'
    ],
    'koowa.select2.js': [
        'node_modules/select2/dist/js/select2.js',
        assetsPath+'/js/koowa.select2.js'
    ],
    'koowa.js': [
        assetsPath+'/js/kquery.set.js',
        assetsPath+'/js/jquery.ui.widget.js',
        assetsPath+'/js/koowa.scopebar.js',
        assetsPath+'/js/koowa.class.js',
        assetsPath+'/js/koowa.grid.js',
        assetsPath+'/js/koowa.js',
        assetsPath+'/js/kquery.unset.js'
    ]
};

if (process.argv.length > 2) {
    var changed = process.argv[2];
    //path.replace(assetsPath, '');

    var changed = path.resolve(__dirname, '../'+changed);
}

for (var destination of Object.keys(map)) {
    var files = map[destination];

    if (changed && files.indexOf(changed) === -1) {
        continue;
    }

    var result = UglifyJS.minify(files);

    console.log('/js/min/'+destination);
    fs.writeFile(assetsPath+'/js/min/'+destination, result.code);

    console.log('/js/build/'+destination);
    concat(assetsPath+'/js/build/'+destination, files);
}
