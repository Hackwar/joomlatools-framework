/**
 * DOCman Categories Tree
 *
 * Customized instance of jqTree to render a list of categories in a tree structure.
 * It deals with turning a flat list into a hierarchy structure that jqTree understands.
 * And it changes the default styling and behavior to match the general DOCman GUI.
 *
 * @copyright	Copyright (C) 2007 - 2013 Johan Janssens and Timble CVBA. (http://www.timble.net)
 * @license		GNU GPLv3 <http://www.gnu.org/licenses/gpl.html>
 * @requires    Koowa.Class, jqTree plugin
 */var DOCman=DOCman||{};DOCman.hasOwnProperty("Tree")||(DOCman.Tree={}),function(e){DOCman.Tree.Categories=Koowa.Class.extend({initialize:function(t,n){this.setOptions(n),this.element=e(t),this.element.css("position","relative"),this.attachHandlers(),this.options.data=this.parseData(this.options.data),this.tree=e.proxy(this.element.tree,this.element),this.tree(this.options)},getDefaults:function(){var t=this,n={lang:{root:"All Categories"},data:[],autoOpen:0,useContextMenu:!1,onCreateLi:function(n,r){r.find(".jqtree-element").attr("title",n.name).wrap(e("<a />",{href:"#",on:{click:function(r){e(r.target).is(".jqtree-element")||(r.preventDefault(),r.stopPropagation(),t.tree("selectNode",t.tree("getSelectedNode")!==n?n:null))}}}));if(n.isFolder()){var i=[{triangle:["icon-triangle-right","&#x25ba;"],folder:"icon-folder-close"},{triangle:["icon-triangle-down","&#x25bc;"],folder:"icon-folder-open"}],s=i[n.is_open?1:0],o=e("<i />",{"class":s.triangle[0],html:s.triangle[1],on:{click:function(e){e.preventDefault(),e.stopPropagation(),t.element.tree("toggle",n);var r=i[n.is_open?1:0],s=i[n.is_open?0:1];o.removeClass(s.triangle[0]).addClass(r.triangle[0]).html(r.triangle[1]),o.closest("a").find("."+s.folder).removeClass(s.folder).addClass(r.folder)}}});r.find(".jqtree-title").prepend('<i class="'+s.folder+'"></i> ').prepend(o)}else r.find(".jqtree-title").prepend('<i class="icon-folder-close"></i> ').prepend('<i class="icon-triangle-hide"></i>');for(var u=0;u<n.level;++u)r.find(".jqtree-title").prepend('<i class="icon-whitespace"></i> ')}};return n},setOptions:function(t){return this.options=e.extend(!0,{},this.getDefaults(),t),this},selectNode:function(e,t){var n=[-1],r=t.tree("getState");n.push.apply(n,e.path.split("/").map(function(e){return parseInt(e,10)})),r.selected_node=e.id,r.open_nodes.push.apply(r.open_nodes,n),t.tree("setState",r)},parseData:function(e){return[{label:this.options.lang.root,id:-1,children:this._parseData(e)}]},_parseData:function(t){var n=[],r={},i=!1;return e.each(t,function(e,t){r[t.id]=t;var s=t.parent_node||t.parent;i===!1&&(i=parseInt(t.level,10)-1),i>0&&(t.level=Math.max(t.level-i,0)),t.parent==0||!r.hasOwnProperty(s)?n.push(t):(r[s].hasOwnProperty("children")||(r[s].children=[]),r[s].children.push(t))}),n},unserialize:function(e){var t,n={};e=e.replace(/^\?/,"").split(/&/);for(t in e)e.hasOwnProperty(t)&&(t=e[t].split("="),n[decodeURIComponent(t[0])]=decodeURIComponent(t[1]));return n},attachHandlers:function(){var t=this.options,n=this,r=n.unserialize(window.location.search);this.element.bind({"tree.select":function(t){if(t.node){e(this).find(".active").removeClass("active").find("[class^=icon-folder]").removeClass("icon-white"),e(this).find(".jqtree-selected").addClass("active").find("[class^=icon-folder]").addClass("icon-white");var n=t.node,i=n.id>0?n.id:"";e.extend(r,{category:i}),window.location.search=e.param(r)}},"tree.open":function(t){var r=t.node,i=e(r.element),s=n.element.height(),o=i[0].offsetTop,u=i.height(),a=Math.min(o,o-s+u);a>n.element.scrollTop()&&n.element.stop().animate({scrollTop:a},300)},"tree.init":function(){e(this).find("ul.jqtree-tree").addClass("sidebar-nav"),t.selected&&n.selectNode(e(this).tree("getNodeById",t.selected),e(this)),n.element.one("resize",function(){if(n.tree("getSelectedNode")){var t=n.tree("getSelectedNode"),r=e(t.element),i=n.element.height(),s=r[0].offsetTop,o=r.height(),u=Math.min(s,s-i+o);n.element.stop().animate({scrollTop:u},900)}})},"tree.refresh":function(){e(this).find("ul.jqtree-tree").addClass("sidebar-nav"),e(this).find(".jqtree-selected").addClass("active").find("[class^=icon-folder]").addClass("icon-white")}})}})}(window.jQuery);