(function($){Koowa.Tree=Koowa.Class.extend({initialize:function(element,options){this.setOptions(options);this.element=$(element);if(this.options.onBeforeInitialize)this.options.onBeforeInitialize.call(this);this.element.css("position","relative");this.attachHandlers();if(this.options.data&&this.options.data.length)this.options.data=this.parseData(this.options.data);this.tree=$.proxy(this.element.tree,this.element);this.tree(this.options);if(this.options.onAfterInitialize)this.options.onAfterInitialize.call(this)},getDefaults:function(){var self=this,defaults={selected:null,data:[],autoOpen:0,useContextMenu:false,toggler:[{triangle:["icon-triangle-right","&#x25ba;"],folder:"icon-folder-close"},{triangle:["icon-triangle-down","&#x25bc;"],folder:"icon-folder-open"}],onCreateLi:function(node,$li){$li.find(".jqtree-element").attr("title",node.name).wrap($("<a />",{href:"javascript:void(0)",on:{click:function(event){event.preventDefault();event.stopPropagation();self.tree("selectNode",node)}}}));if(node.isFolder()){var states=self.options.toggler,state=states[node.is_open?1:0],triangle=$("<i />",{"class":"icon-toggler "+state.triangle[0],html:state.triangle[1],on:{click:function(event){event.preventDefault();event.stopPropagation();self.element.tree("toggle",node)}}});$li.find(".jqtree-title").prepend('<i class="'+state.folder+'"></i> ').prepend(triangle)}else{$li.find(".jqtree-title").prepend('<i class="icon-folder-close"></i> ').prepend('<i class="icon-triangle-hide"></i>')}var level=node.getLevel();for(var i=1;i<level;++i){$li.find(".jqtree-title").prepend('<i class="icon-whitespace"></i> ')}}};return defaults},setOptions:function(options){this.options=$.extend(true,{},this.getDefaults(),options);return this},selectNode:function(node,element){var nodes=[-1],state=element.tree("getState");nodes.push.apply(nodes,node.path.split("/").map(function(item){return parseInt(item,10)}));state.selected_node=node.id;state.open_nodes.push.apply(state.open_nodes,nodes);element.tree("setState",state)},parseData:function(list){return this._parseData(list)},_parseData:function(list){var data=[],index={};$.each(list,function(key,item){index[item.id]=item;if(item.parent==0||!index.hasOwnProperty(item.parent)){data.push(item)}else{if(!index[item.parent].hasOwnProperty("children"))index[item.parent].children=[];index[item.parent].children.push(item)}});return data},unserialize:function(query){var pair,params={};query=query.replace(/^\?/,"").split(/&/);for(pair in query){if(query.hasOwnProperty(pair)){pair=query[pair].split("=");params[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}}return params},_attachHandlers:function(){var options=this.options,self=this,states=options.toggler;this.element.bind({"tree.select":function(event){$(this).find(".active").removeClass("active").find(".icon-white").removeClass("icon-white");if(event.node){$(this).find(".jqtree-selected").addClass("active").children("a").find("[class^=icon-folder]").addClass("icon-white")}},"tree.open":function(event){var node=event.node,state=states[1],old=states[0],triangle=$(node.element).children("a").find(".icon-toggler");triangle.removeClass(old.triangle[0]).addClass(state.triangle[0]).html(state.triangle[1]);triangle.closest("a").find("."+old.folder).removeClass(old.folder).addClass(state.folder)},"tree.close":function(event){var node=event.node,state=states[0],old=states[1],triangle=$(node.element).children("a").find(".icon-toggler");triangle.removeClass(old.triangle[0]).addClass(state.triangle[0]).html(state.triangle[1]);triangle.closest("a").find("."+old.folder).removeClass(old.folder).addClass(state.folder)},"tree.init":function(){$(this).find("ul.jqtree-tree").addClass("sidebar-nav");if(options.selected){self.selectNode($(this).tree("getNodeById",options.selected),$(this))}},"tree.refresh":function(){$(this).find("ul.jqtree-tree").addClass("sidebar-nav");$(this).find(".jqtree-selected").addClass("active").children("a").find("[class^=icon-folder]").addClass("icon-white")}})},attachHandlers:function(){this._attachHandlers()},scrollIntoView:function(node,viewport,duration){var element=$(node.element),viewportHeight=viewport.height(),offsetTop=element[0].offsetTop,height=element.height(),scrollTo=Math.min(offsetTop,offsetTop-viewportHeight+height);if(scrollTo>viewport.scrollTop()){viewport.animate({scrollTop:scrollTo},duration||900)}else if(offsetTop<viewport.scrollTop()){viewport.animate({scrollTop:offsetTop},duration||900)}}})})(window.jQuery);